<app-navbar></app-navbar>
<div class="container mt-4">
    <div class="progress-bar-custom">
        <div class="progress-fill"></div>
    </div>
    <div class="text-end text-muted mb-2 pe-2">{{currentStep}}/4</div>

    <!-- Heading -->
    <h2>Where to?</h2>

    <!-- Search Box -->
    <div class="search-box">
        <input type="text" class="form-control form-control-lg rounded-pill" placeholder="Search destinations"
            [(ngModel)]="searchTerm" />
        <button class="btn btn-primary rounded-pill ms-2 my-4" (click)="getDestinationsForTrip()">Search</button>
    </div>

    <!-- tour packages -->
    @defer (when isPackageReqFinished) {
    @if(trip.tourPackages.length == 0){
    <h2>No Tour Packages are available</h2>
    }@else {
    <div class="mb-4 tour-packages" *ngIf="currentStep === 1">
        <h5 class="mb-3">Tour Packages</h5>
        <div class="row g-4">
            @for (item of trip.tourPackages; track $index) {
            <div class="col-6 col-md-4 col-lg-2">
                <div class="destination-card" (click)="packageSelected(item,$event)">
                    <img [src]="item.photoUrls![0]" [alt]="item.packageName" class="destination-img">
                    <div class="destination-name">{{item.packageName}}</div>
                    <div class="destination-name">${{item.price}}</div>
                </div>
            </div>
            @if (selectedPackage?.packageId == item.packageId) {
            <div class="selected-date">
                <input type="date" class="form-control" placeholder="Booking Date"
                    [attr.min]="item.startDate.split('T')[0]" [attr.max]="item.endDate.split('T')[0]"
                    (change)="editPackageDate($event)" />
            </div>
            }
            }


            <div class="next-button mt-5 ms-auto">
                <button class="btn btn-next" (click)="skipToNext()" [disabled]="selectedDate == null">Next</button>
            </div>
        </div>
    </div>
    <div class="rooms" *ngIf="currentStep === 2">
        @if (trip.hotelsRooms.length == 0) {
        <h2>No Rooms Are available for this area</h2>

        }@else {
        <div class="row g-4">
            @for (item of trip.hotelsRooms[0]; track $index) {
            <div class="col-6 col-md-4 col-lg-2">
                <div class="room-card" (click)="roomSelected(item,$event)">
                    <img [src]="item.photoUrls![0]" [alt]="item.photoUrls[0]">
                    <div class="room-name">Hotel Name : {{item.hotelName}}</div>
                    <div class="room-type">Room Type : {{item.roomType}}</div>
                    <div class="room-price">Price : ${{item.pricePerNight}} / Night</div>
                </div>
                @if (selectedRoom?.roomId == item.roomId) {
                <div class="nights-number">
                    <button [disabled]="selectedRoom?.roomId != item.roomId" (click)="increaseNights()">+</button>
                    <input type="number" [(ngModel)]="numberOfNights" /> Nights
                    <button [disabled]="selectedRoom?.roomId  != item.roomId" (click)="decreaseNights()">-</button>
                </div>
                }
            </div>

            }
        </div>
        }
        <div class="next-button mt-5 ms-auto">
            <button class="btn btn-next mt-5" (click)="skipToNext()">Next</button>
        </div>
    </div>
    <div class="guides" *ngIf="currentStep === 3">
        @if (trip.tourGuides.length == 0) {
        <h2>No Tour Guides Are available for this area</h2>

        }@else {
        <div class="row g-4">
            @for (item of trip.tourGuides; track $index) {
            <div class="col-6 col-md-4 col-lg-2">
                <div class="guide-card mt-4" (click)="guideSelected(item,$event)">
                    <img [src]="item.photoUrls![0]" [alt]="item.photoUrls[0]">
                    <div class="guide-name">Guide Name : {{item.guideName}}</div>
                    <div class="guide-rating">Rating : {{item.averageRating}} <svg xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 576 512">
                            <path
                                d="M316.9 18C311.6 7 300.4 0 288.1 0s-23.4 7-28.8 18L195 150.3 51.4 171.5c-12 1.8-22 10.2-25.7 21.7s-.7 24.2 7.9 32.7L137.8 329 113.2 474.7c-2 12 3 24.2 12.9 31.3s23 8 33.8 2.3l128.3-68.5 128.3 68.5c10.8 5.7 23.9 4.9 33.8-2.3s14.9-19.3 12.9-31.3L438.5 329 542.7 225.9c8.6-8.5 11.7-21.2 7.9-32.7s-13.7-19.9-25.7-21.7L381.2 150.3 316.9 18z" />
                        </svg>
                    </div>
                    <div class="room-price">Price : ${{item.pricePerHour}} / Hour</div>
                </div>
                @if (selectedTourGuide?.guideID == item.guideID) {
                <div class="nights-number">
                    <button [disabled]="selectedTourGuide?.guideID != item.guideID"
                        (click)="increaseGuideHours()">+</button>
                    <input type="number" [(ngModel)]="guideHours" />Hour
                    <button [disabled]="selectedTourGuide?.guideID  != item.guideID"
                        (click)="decreaseGuideHours()">-</button>
                </div>
                }
            </div>

            }


            <div class="next-button mt-5 ms-auto">
                <button class="btn btn-next mt-5" (click)="skipToNext()">Next</button>
            </div>
        </div>
        }
    </div>
    <div class="final-booking" *ngIf="currentStep === 4">
        <div class="card shadow p-4">
            <h3 class="mb-4 text-center border-bottom pb-2">Booking Receipt</h3>

            @if(selectedPackage){
            <div class="mb-2 d-flex justify-content-between">
                <strong>Package:</strong>
                <span>{{ selectedPackage.packageName }}</span>
            </div>
            }

            @if(selectedRoom){
            <div class="mb-2 d-flex justify-content-between">
                <strong>Hotel:</strong>
                <span>{{ selectedRoom.hotelName }}</span>
            </div>
            }

            @if (selectedTourGuide) {
            <div class="mb-2 d-flex justify-content-between">
                <strong>Tour Guide:</strong>
                <span>{{ selectedTourGuide.guideName }}</span>
            </div>
            }

            @if(selectedDate){
            <div class="mb-2 d-flex justify-content-between">
                <strong>Check-in Date:</strong>
                <span>{{ selectedDate.toDateString().split('T')[0]}}</span>
            </div>
            }

            <hr />

            <div class="d-flex justify-content-between fs-5">
                <strong>Total Price:</strong>
                <span>{{ totalPrice | currency }}</span>
            </div>

            <div class="text-center mt-4">
                <button class="btn btn-success px-4" (click)="bookTrip()">Confirm & Book</button>
            </div>
        </div>
    </div>

    }
    }@placeholder {
    <h2>Search for a good tour package</h2>
    }@loading (minimum 3s) {
    <mat-progress-spinner mode="indeterminate" color="accent" diameter="40" class="mx-auto"></mat-progress-spinner>
    }
</div>